# Model Management and Versioning

## Overview

Effective model management is crucial for tracking experiments, ensuring reproducibility, and comparing model performance over time. This project implements a file-based model versioning and registration system.

## Model Versioning Scheme

Each trained model is assigned a unique version string and stored in a structured directory.

-   **Version String Format:** `v<YYYYMMDDHHMMSS>_<short_git_hash>`
    -   Example: `v20231027143055_a1b2c3d`
    -   The timestamp ensures uniqueness and chronological order.
    -   The short Git hash links the model to a specific code state (if available, otherwise "nogit" is used).
    -   This is generated by `src.pipeline_utils.get_model_version_str()`.

-   **Directory Structure:**
    Models are stored under a base path (defined in `TrainModelConfig.model_output_path_base`), then categorized by model type/name, and then by version string.
    ```
    <model_output_path_base>/
    └── <MODEL_TYPE_OR_NAME>/
        └── <VERSION_STRING>/
            ├── model.<ext>                 # The actual model file (e.g., model.joblib, model.keras)
            ├── model.meta.json             # Metadata for this model version
            └── training_run_config.json    # Training configuration for this run
    ```
    -   **Example:**
        ```
        models_output/
        └── XGBoost_StockPredictor/
            └── v20231027143055_a1b2c3d/
                ├── model.joblib
                ├── model.meta.json
                └── training_run_config.json
        ```
    -   This structure is created by `src.pipeline_utils.get_versioned_model_paths()`.

## Model Artifacts (per version)

For each trained and versioned model, the following artifacts are typically saved:

1.  **`model.<ext>`**:
    *   The serialized model file itself.
    *   The extension (`.joblib`, `.keras`, `.h5`, `.cbm`, `.txt`, etc.) depends on the model type and serialization method used by `src.utils.save_model()`.

2.  **`model.meta.json`**:
    *   A JSON file containing comprehensive metadata about the model version. Generated by `src.metadata_utils.generate_model_metadata()`.
    *   **Key Fields:**
        *   `model_name_from_config`: The general name or type of the model (e.g., "XGBoost").
        *   `model_version`: The unique version string.
        *   `model_filename`: The filename of the model artifact (e.g., "model.joblib").
        *   `model_filepath_full`: Absolute path to the model file (for unambiguous reference).
        *   `timestamp_utc`: ISO 8601 timestamp of when the metadata was generated.
        *   `model_content_hash`: SHA256 hash of the model file's content.
        *   `metrics`: Dictionary of evaluation metrics (e.g., accuracy, F1-score, AUC).
        *   `feature_config_used`: Dictionary describing the features used for training (e.g., list of feature names, preprocessing steps).
        *   `training_config_file`: Relative path to the `training_run_config.json` file (within the versioned directory).
        *   `reproducibility_details`:
            *   `reproducibility_hash_sha256`: A hash combining model content, Git commit, library versions, and training config.
            *   `git_commit_hash`: Git commit hash of the codebase at the time of training.
            *   `library_versions`: Versions of key Python libraries used.
        *   `schema_version_metadata`: Version of the metadata schema itself (e.g., "1.1.0").

3.  **`training_run_config.json`**:
    *   A JSON file that stores a snapshot of the `TrainModelConfig` (from `src/config_models.py`) used for this specific training run.
    *   This includes model parameters, input data paths, target column, etc., providing a complete record of the training setup.

## Model Registry (`models/model_registry.jsonl`)

The model registry acts as a central manifest or catalog for all registered model versions.

-   **Location:** `models/model_registry.jsonl` (configurable via `MODEL_REGISTRY_FILE` in `src.model_registry_utils.py`).
-   **Format:** JSON Lines (`.jsonl`), where each line is a separate, self-contained JSON object representing one registered model version.
-   **Purpose:**
    *   Provides a quick way to discover available models and their key details without scanning the entire model directory structure.
    *   Facilitates programmatic access to model versions (e.g., for listing, fetching the latest, or getting specific version details).
-   **Key Fields per Entry:**
    *   `model_name_from_config`: The general name/type of the model.
    *   `model_version`: The unique version string.
    *   `timestamp_utc`: Timestamp of metadata generation.
    *   `primary_metric_name`: Name of a key metric chosen for quick reference (e.g., "accuracy", "f1_score").
    *   `primary_metric_value`: Value of that primary metric.
    *   `meta_json_path`: Relative path from the project root to the model's `.meta.json` file.

## Automatic Registration

Models are automatically registered after successful training.
-   The `train_<model_type>` functions in `src/modeling.py` are responsible for the training process.
-   After a model is trained and its metadata (`.meta.json`) is generated, the training function calls `src.model_registry_utils.register_model(path_to_meta_json)`.
-   This function appends a summary entry to the `models/model_registry.jsonl` file.
-   File locking (`fcntl`) is used during the append operation to prevent race conditions if multiple processes were to attempt registration simultaneously (primarily relevant for Unix-like systems).

## CLI Commands for Model Management

The project provides CLI commands under the `models` group for interacting with the model registry and metadata. You can use `qlop-cli` (if `setup.py` installation created the entry point) or `python main.py`.

-   **`qlop-cli models list [--name <MODEL_NAME>]`**
    -   **Action:** Lists all registered model versions. Can be filtered by model name.
    -   **Example:**
        ```bash
        python main.py models list
        python main.py models list --name XGBoostTest
        ```

-   **`qlop-cli models describe <MODEL_NAME> <VERSION_STRING>`**
    -   **Action:** Displays the full `.meta.json` content for a specific model version.
    -   **Example:**
        ```bash
        python main.py models describe XGBoostTest v20230102000000_def456
        ```

-   **`qlop-cli models compare <MODEL_NAME> <VERSION1> <VERSION2> [<VERSION3>...]`**
    -   **Action:** Compares the metadata of two or more versions of a specified model.
    -   **Example:**
        ```bash
        python main.py models compare XGBoostTest v20230101000000_abc123 v20230102000000_def456
        ```

-   **`qlop-cli models get-latest-path <MODEL_NAME>`**
    -   **Action:** Prints the relative path to the `.meta.json` file of the latest registered version for the given model name.
    -   **Example:**
        ```bash
        python main.py models get-latest-path XGBoostTest
        ```

## Manual Re-registration (Optional)

If a model's metadata file (`.meta.json`) exists but its entry is missing from `models/model_registry.jsonl` (e.g., due to manual file manipulation or a previous error), you can re-register it using a Python script:

```python
# Example: scripts/manual_register.py
import sys
sys.path.append('.') # Ensure 'src' can be imported
from src.model_registry_utils import register_model

if __name__ == "__main__":
    meta_file_to_register = "models/YourModelType/vYYYYMMDDHHMMSS_githash/model.meta.json"
    if register_model(meta_file_to_register):
        print(f"Successfully re-registered: {meta_file_to_register}")
    else:
        print(f"Failed to re-register: {meta_file_to_register}")
```
Run this script with `python scripts/manual_register.py`. Ensure the path in `meta_file_to_register` is correct.
